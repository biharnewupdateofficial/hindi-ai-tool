<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>OpenTutor AI</title>
<link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="layout">
    <div class="sidebar">
        <div class="sidebar-header">
            ðŸ¤– OpenTutor AI
            <button onclick="location.href='/new-chat'">ï¼‹ New</button>
        </div>
        <div class="sidebar-footer">
            {{ username }} |
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="main">
        <div id="chat-box">
            {% for m in history %}
                <div class="{{ 'user-msg' if m.role=='user' else 'ai-msg' }}">
                    {{ m.content }}
                </div>
            {% endfor %}
        </div>

        <div class="input-bar">
            <input type="file" id="fileInput">
            <textarea id="question" placeholder="Message..."></textarea>
            <button onclick="send()">âž¤</button>
        </div>
    </div>
</div>

<script>
const chat = document.getElementById("chat-box");

document.getElementById("fileInput").onchange = () => {
    const file = fileInput.files[0];
    const form = new FormData();
    form.append("file", file);
    fetch("/upload", { method:"POST", body:form });
};

function send(){
    const q = question.value.trim();
    if(!q) return;

    chat.innerHTML += `<div class='user-msg'>${q}</div>`;
    const ai = document.createElement("div");
    ai.className="ai-msg";
    chat.appendChild(ai);
    question.value="";

    fetch("/ask",{
        method:"POST",
        headers:{ "Content-Type":"application/json"},
        body:JSON.stringify({question:q})
    }).then(r=>{
        const rd=r.body.getReader();
        const dec=new TextDecoder();
        function read(){
            rd.read().then(({done,value})=>{
                if(done) return;
                ai.innerText+=dec.decode(value);
                chat.scrollTop=chat.scrollHeight;
                read();
            })
        }
        read();
    })
}
</script>

</body>
</html>
