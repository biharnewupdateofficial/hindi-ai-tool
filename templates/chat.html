<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OpenTutor AI</title>

<style>
:root{
    --bg:#f5f5f5; --card:#ffffff; --text:#000;
    --user:#2563eb; --ai:#e5e7eb;
}
.dark{
    --bg:#0f172a; --card:#1e293b; --text:#f1f5f9;
    --ai:#334155;
}
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:var(--bg);color:var(--text);}
.app{display:flex;height:100vh}

/* Sidebar */
.sidebar{
    width:280px;background:var(--card);
    padding:10px;border-right:1px solid #444;
    display:flex;flex-direction:column
}
.sidebar h2{margin:10px 0}
.sidebar button{
    width:100%;padding:10px;margin-bottom:8px;
    border:none;border-radius:8px;cursor:pointer
}
.new{background:#22c55e;color:white}
.toggle{background:#6366f1;color:white}
.logout{background:#ef4444;color:white}

.chat-list{
    flex:1;overflow-y:auto;margin-top:10px
}
.chat-item{
    padding:8px;border-radius:6px;
    background:#ddd;margin-bottom:6px;
    cursor:pointer;
    display:flex;justify-content:space-between;
    align-items:center;font-size:14px
}
.dark .chat-item{background:#334155}
.chat-item span{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chat-item button{
    margin-left:4px;border:none;
    background:none;cursor:pointer
}

/* Chat */
.chat-area{flex:1;display:flex;flex-direction:column}
.header{
    padding:15px;background:var(--card);
    border-bottom:1px solid #444;font-weight:bold
}
.chat-box{
    flex:1;padding:20px;overflow-y:auto
}
.user{
    background:var(--user);color:white;
    padding:10px;border-radius:12px;
    max-width:70%;margin:8px 0;margin-left:auto
}
.ai{
    background:var(--ai);padding:10px;
    border-radius:12px;max-width:70%;
    margin:8px 0
}
.typing{opacity:.7;font-style:italic}

/* Input */
.input{
    display:flex;padding:15px;background:var(--card)
}
textarea{
    flex:1;padding:10px;border-radius:8px;border:none
}
.send{
    margin-left:10px;padding:0 20px;
    border:none;border-radius:8px;
    background:#22c55e;color:white
}
</style>
</head>

<body>
<div class="app">

<div class="sidebar">
    <h2>ðŸ¤– OpenTutor AI</h2>
    <button class="new" onclick="newChat()">âž• New Chat</button>
    <button class="toggle" onclick="toggle()">ðŸŒ— Dark / Light</button>
    <button class="logout" onclick="location.href='/logout'">ðŸšª Logout</button>

    <div class="chat-list" id="chatList"></div>
</div>

<div class="chat-area">
    <div class="header">ChatGPT + Gemini Mode</div>
    <div id="chatBox" class="chat-box"></div>
    <div class="input">
        <textarea id="q" placeholder="Type message..."></textarea>
        <button class="send" onclick="send()">Send</button>
    </div>
</div>

</div>

<script>
let chats = JSON.parse(localStorage.getItem("chats")||"{}");
let current = localStorage.getItem("current") || null;
const chatBox = document.getElementById("chatBox");
const list = document.getElementById("chatList");
const input = document.getElementById("q");

/* THEME */
if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark");
function toggle(){
    document.body.classList.toggle("dark");
    localStorage.setItem("theme",
        document.body.classList.contains("dark")?"dark":"light");
}

/* SAVE */
function save(){
    localStorage.setItem("chats",JSON.stringify(chats));
    localStorage.setItem("current",current);
}

/* RENDER SIDEBAR */
function renderList(){
    list.innerHTML="";
    Object.keys(chats).forEach(id=>{
        let item=document.createElement("div");
        item.className="chat-item";

        let title=document.createElement("span");
        title.innerText=chats[id].title;
        title.onclick=()=>loadChat(id);

        let rename=document.createElement("button");
        rename.innerText="âœï¸";
        rename.onclick=()=>{
            let n=prompt("Rename chat",chats[id].title);
            if(n){chats[id].title=n;save();renderList();}
        };

        let del=document.createElement("button");
        del.innerText="ðŸ—‘ï¸";
        del.onclick=()=>{
            if(confirm("Delete this chat?")){
                delete chats[id];
                if(current===id) current=null;
                save();
                renderList();
                if(!current) newChat();
            }
        };

        let exp=document.createElement("button");
        exp.innerText="â¬‡ï¸";
        exp.onclick=()=>exportChat(id);

        item.append(title,rename,del,exp);
        list.appendChild(item);
    });
}

/* NEW CHAT */
function newChat(){
    let id="chat_"+Date.now();
    chats[id]={title:"New Chat",messages:[]};
    current=id;
    save();
    renderList();
    loadChat(id);
}

/* LOAD CHAT */
function loadChat(id){
    current=id;
    chatBox.innerHTML="";
    chats[id].messages.forEach(m=>{
        add(m.text,m.role,false);
    });
    save();
}

/* ADD MESSAGE */
function add(text,role,saveIt=true){
    let d=document.createElement("div");
    d.className=role;
    d.innerText=text;
    chatBox.appendChild(d);
    chatBox.scrollTop=chatBox.scrollHeight;
    if(saveIt){
        chats[current].messages.push({text,role});
        if(chats[current].messages.length===1)
            chats[current].title=text.slice(0,30);
        save();renderList();
    }
}

/* SEND */
function send(){
    let q=input.value.trim();
    if(!q) return;
    add(q,"user");
    input.value="";

    let t=document.createElement("div");
    t.className="ai typing";
    t.id="typing";
    t.innerText="AI likh raha haiâ€¦";
    chatBox.appendChild(t);

    fetch("/ask",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({question:q})
    })
    .then(r=>r.json())
    .then(d=>{
        document.getElementById("typing")?.remove();
        add(d.answer,"ai");
    });
}

/* ENTER SEND */
input.addEventListener("keydown",e=>{
    if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();send();
    }
});

/* EXPORT */
function exportChat(id){
    let text=chats[id].messages
        .map(m=>(m.role==="user"?"You: ":"AI: ")+m.text)
        .join("\n\n");
    let blob=new Blob([text],{type:"text/plain"});
    let a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=chats[id].title+".txt";
    a.click();
}

/* INIT */
if(!current) newChat();
else loadChat(current);
renderList();
</script>
</body>
</html>
